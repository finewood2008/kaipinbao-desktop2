

# PRD 对话功能重构计划

## 需求理解

重构 PRD 对话模块，实现以下目标：
1. AI 扮演专业产品经理角色，分析竞品研究数据和用户提供的原始资料
2. 通过智能对话获取用户的方向性信息补充
3. 快速生成完整的产品 PRD 文档
4. 对话区域采用滚动框设计，用户可清晰看到对话进度
5. 对话完成后自动引导用户进入 PRD 审核页面

---

## 当前问题分析

### 现有实现
- `PrdChatPanel` 组件已有基本对话功能
- 使用 `ScrollArea` 组件但存在滚动行为问题
- AI 提示词已包含产品经理角色，但需要强化专业性
- 对话完成检测依赖 `[PRD_READY]` 信号，但引导不够明显

### 需要优化的点
1. **滚动框体验**：确保用户始终能看到最新对话和进度
2. **对话进度可视化**：让用户清楚知道当前所处阶段
3. **AI 专业性强化**：更专业的产品经理角色扮演
4. **自动引导**：对话完成后更明显的引导进入审核页面

---

## 技术实现

### 第一部分：优化对话滚动体验

**文件**：`src/components/PrdChatPanel.tsx`

**改动要点**：
1. 改进 ScrollArea 的 ref 绑定和滚动行为
2. 添加对话进度指示器
3. 新增"滚动到底部"浮动按钮
4. 优化对话消息的布局和间距

```text
布局结构：
┌────────────────────────────────────────────────────┐
│  📊 对话进度：信息收集中... (2/4)         [到底部] │
├────────────────────────────────────────────────────┤
│                                                    │
│  [竞品洞察卡片]                                    │
│                                                    │
│  ┌──────────────────────────────────────────────┐  │
│  │ 🤖 AI：基于竞品分析...                       │  │
│  │      [选项A] | [选项B] | [选项C]             │  │
│  └──────────────────────────────────────────────┘  │
│                                                    │
│  ┌──────────────────────────────────────────────┐  │
│  │ 👤 用户：我选择A                              │  │
│  └──────────────────────────────────────────────┘  │
│                                                    │
│  ┌──────────────────────────────────────────────┐  │
│  │ 🤖 AI：好的，接下来...                        │  │
│  │      [选项A] | [选项B]                       │  │ ← 可滚动
│  └──────────────────────────────────────────────┘  │
│                                                    │
├────────────────────────────────────────────────────┤
│  [输入框]                              [发送]     │
└────────────────────────────────────────────────────┘
```

**核心代码改动**：
- 使用 `useRef` + `scrollIntoView` 实现更可靠的自动滚动
- 添加 `IntersectionObserver` 检测用户是否在底部
- 当用户手动向上滚动时，显示"回到底部"按钮
- 流式消息时保持自动滚动到底部

### 第二部分：对话进度指示器

**新增组件**：`src/components/ChatProgressIndicator.tsx`

**功能**：
- 显示当前对话阶段（如"方向确认 2/3"）
- 根据已收集的信息动态计算进度
- 可点击跳转到特定阶段消息

```text
进度条样式：
┌─────────────────────────────────────────────────────────┐
│  📍 产品方向确认          ●───●───○───○            2/4 │
│     [产品定位] ✓  [用户画像] ✓  [风格选择]  [功能]     │
└─────────────────────────────────────────────────────────┘
```

### 第三部分：强化 AI 产品经理角色

**文件**：`supabase/functions/chat/index.ts`

**提示词优化**：

```text
你是"开品宝"的资深产品经理顾问。你拥有10年消费品产品开发经验。

## 你的工作方式

### 第一步：深入分析已有资料
收到竞品数据后，你必须：
1. **全面解读竞品特征**
   - 从产品图片分析：材质工艺、造型语言、配色策略
   - 从评论数据分析：用户真实痛点、满意点、期望值
   - 提炼市场趋势和机会点

2. **形成专业洞察报告**
   展示给用户时使用结构化格式：
   📊 竞品分析摘要
   ├─ 市场概况：X款竞品，Y条用户评价
   ├─ 外观趋势：[趋势描述]
   ├─ 用户好评：[TOP 3 好评点]
   ├─ 用户痛点：[TOP 3 痛点]
   └─ 创新机会：[2-3个差异化方向]

### 第二步：引导式需求确认
基于分析结果，提出 2-4 个关键决策点：
- 每次只问一个问题
- 提供 3-4 个明确选项
- 附带专业建议（如"根据竞品痛点分析，建议选择A"）

### 第三步：快速生成完整 PRD
收集到足够信息后（通常 3-4 轮对话）：
1. 自动补全未明确的细节
2. 生成完整 PRD 文档
3. 输出 [PRD_READY] 信号
4. 明确告知用户进入审核页面
```

### 第四部分：对话完成自动引导

**文件**：`src/pages/Project.tsx` 和 `src/components/PrdChatPanel.tsx`

**改动要点**：
1. 检测到 `[PRD_READY]` 后显示更醒目的引导卡片
2. 添加动画效果吸引注意力
3. 提供倒计时自动跳转选项

```text
PRD 完成引导卡片样式：
┌──────────────────────────────────────────────────────────┐
│  🎉                                                      │
│                                                          │
│     PRD 文档已生成完成！                                  │
│                                                          │
│     我们已基于您的选择和竞品分析生成了完整的产品需求文档。 │
│     您可以在审核页面查看详情并进行修改。                   │
│                                                          │
│        [继续对话]          [✨ 查看 PRD 文档]             │
│                                                          │
│                   5秒后自动进入审核页面...                │
└──────────────────────────────────────────────────────────┘
```

### 第五部分：优化消息渲染

**文件**：`src/components/ChatMessage.tsx`

**改动要点**：
1. 为 AI 消息添加"产品经理"身份标识
2. 优化选项按钮的样式和交互
3. 添加消息时间戳（可选显示）

---

## 文件变更清单

| 文件路径 | 操作 | 描述 |
|---------|------|------|
| `src/components/PrdChatPanel.tsx` | 重构 | 优化滚动行为、添加进度指示、完成引导 |
| `src/components/ChatProgressIndicator.tsx` | 新建 | 对话进度可视化组件 |
| `src/components/ChatMessage.tsx` | 修改 | 添加 AI 身份标识、优化选项样式 |
| `src/pages/Project.tsx` | 修改 | 优化 PRD 完成引导和自动跳转逻辑 |
| `supabase/functions/chat/index.ts` | 修改 | 强化产品经理角色提示词 |

---

## 滚动行为技术方案

### 问题
当前 `ScrollArea` 使用 `ref` 绑定存在问题：
- `ScrollArea` 的 ref 指向外层容器而非实际滚动的 viewport
- 新消息到来时自动滚动不稳定

### 解决方案

```typescript
// 在消息列表底部添加一个锚点元素
const messagesEndRef = useRef<HTMLDivElement>(null);

// 滚动到底部的函数
const scrollToBottom = useCallback(() => {
  messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
}, []);

// 新消息时自动滚动
useEffect(() => {
  scrollToBottom();
}, [messages, scrollToBottom]);

// 在 JSX 中
<div ref={messagesEndRef} />  // 放在消息列表最后
```

### 用户手动滚动检测

```typescript
const [isAtBottom, setIsAtBottom] = useState(true);

// 使用 IntersectionObserver 检测是否在底部
useEffect(() => {
  const observer = new IntersectionObserver(
    ([entry]) => setIsAtBottom(entry.isIntersecting),
    { threshold: 0.1 }
  );
  
  if (messagesEndRef.current) {
    observer.observe(messagesEndRef.current);
  }
  
  return () => observer.disconnect();
}, []);
```

---

## 对话进度计算逻辑

基于 `prdData` 字段判断收集进度：

```typescript
function calculateDialogueProgress(prdData: PrdData | null): {
  current: number;
  total: number;
  stages: { name: string; completed: boolean }[];
} {
  const stages = [
    { name: "产品定位", completed: !!prdData?.usageScenario },
    { name: "用户画像", completed: !!prdData?.targetAudience },
    { name: "风格选择", completed: !!prdData?.designStyle },
    { name: "核心功能", completed: !!(prdData?.coreFeatures?.length) },
  ];
  
  return {
    current: stages.filter(s => s.completed).length,
    total: stages.length,
    stages,
  };
}
```

---

## PRD 完成自动引导流程

```text
检测到 [PRD_READY]
       │
       ▼
┌───────────────────────────────────────┐
│  显示完成引导卡片                      │
│  启动 5 秒倒计时                       │
└───────────────────────────────────────┘
       │
       ├─── 用户点击"查看PRD" ───────────▶ 立即跳转
       │
       ├─── 用户点击"继续对话" ──────────▶ 关闭卡片，取消倒计时
       │
       └─── 倒计时结束 ──────────────────▶ 自动跳转审核页面
```

---

## 预期效果

1. **对话体验更流畅** - 滚动框始终保持最新消息可见
2. **进度清晰可见** - 用户知道当前处于哪个阶段
3. **AI 更专业** - 产品经理角色更突出，分析更有深度
4. **引导更明确** - 完成后自动引导进入审核页面
5. **操作更便捷** - 可随时回到底部查看最新对话

