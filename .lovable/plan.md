

# PRD 三板块重构计划

## 需求理解

参照视觉生成板块（VisualGenerationPhase）的分阶段设计逻辑，将 PRD 功能重构为三个独立板块：

1. **竞品分析** - 现有功能，使用 Firecrawl API 直接调用
2. **AI产品经理** - 全新对话模块，双栏设计
3. **产品PRD文档** - 审核与编辑页面

---

## 整体架构设计

```text
┌────────────────────────────────────────────────────────────────────────────┐
│                         PRD 阶段指示器                                      │
│  ┌────────────────┐   ────   ┌────────────────┐   ────   ┌───────────────┐ │
│  │ ✓ 竞品分析     │ ──────── │ 📋 AI产品经理  │ ──────── │ 产品PRD文档   │ │
│  └────────────────┘          └────────────────┘          └───────────────┘ │
└────────────────────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────────────────────┐
│                            板块内容区域                                     │
│                                                                            │
│  板块1: 竞品分析                                                           │
│  ├─ Amazon 链接输入                                                        │
│  ├─ Firecrawl 抓取 (直接调用 API)                                          │
│  └─ 评论分析摘要                                                           │
│                                                                            │
│  板块2: AI产品经理 (新设计)                                                │
│  ┌──────────────────────┬───────────────────────────────────────────────┐  │
│  │ PRD 自动提取侧边栏   │          AI 产品经理对话框                      │  │
│  │                      │                                               │  │
│  │ 📍 使用场景: ✓       │  ┌─────────────────────────────────────────┐  │  │
│  │ 👥 目标用户: ✓       │  │ 🤖 PM: 基于竞品分析，我发现...          │  │  │
│  │ 🎨 外观风格: ...     │  │      [选项A] | [选项B] | [选项C]         │  │  │
│  │ ⚡ 核心功能: ...     │  └─────────────────────────────────────────┘  │  │
│  │                      │                                               │  │
│  │ ──────────────       │  ┌─────────────────────────────────────────┐  │  │
│  │ 竞品图片参考         │  │ 👤 用户: 我选择A                         │  │  │
│  │ [图1] [图2] [图3]    │  └─────────────────────────────────────────┘  │  │
│  │                      │                                               │  │
│  │ ──────────────       │  [输入框]                        [发送]      │  │
│  └──────────────────────┴───────────────────────────────────────────────┘  │
│                                                                            │
│  板块3: 产品PRD文档                                                        │
│  ├─ 完整 PRD 展示                                                         │
│  ├─ 手动编辑每个字段                                                       │
│  └─ AI 局部重新生成                                                       │
│                                                                            │
└────────────────────────────────────────────────────────────────────────────┘
```

---

## 技术实现

### 第一部分：新建 PrdPhase 组件

**文件**：`src/components/PrdPhase.tsx`

创建类似 `VisualGenerationPhase` 的容器组件，管理三个阶段：

```text
组件结构:
├─ PrdPhase (主容器)
│   ├─ 阶段指示器 (三个圆形按钮 + 连接线)
│   ├─ 阶段过渡动画
│   └─ 阶段内容切换
│       ├─ Phase 1: CompetitorResearch (已有)
│       ├─ Phase 2: AiProductManagerPanel (新建)
│       └─ Phase 3: PrdDocumentPanel (基于 PrdReviewPanel 改造)
```

**核心逻辑**：
- `currentPhase`: 1 | 2 | 3 状态管理
- 阶段完成检测与自动推进
- 阶段间过渡动画

### 第二部分：阶段指示器

**样式参考**：用户上传的图片（视觉生成阶段指示器）

```text
三阶段样式:
┌────────────────┐      ────      ┌────────────────┐      ────      ┌────────────────┐
│ ✓ 竞品分析     │ ─────────────── │ 📋 AI产品经理  │ ─────────────── │ 📄 PRD文档     │
└────────────────┘                 └────────────────┘                 └────────────────┘
   (已完成-深色)                    (进行中-渐变)                      (待解锁-灰色)
```

**指示器设计**：
- 已完成阶段：深色背景 + 勾选图标
- 当前阶段：渐变背景（purple → cyan）
- 未解锁阶段：灰色背景

### 第三部分：AI产品经理对话模块（核心重构）

**新建文件**：`src/components/AiProductManagerPanel.tsx`

**双栏布局设计**：

```text
┌──────────────────────────────────────────────────────────────────────────────┐
│                       AI 产品经理对话面板                                     │
├────────────────────────┬─────────────────────────────────────────────────────┤
│                        │                                                     │
│   PRD 信息提取侧栏     │              AI 产品经理对话区                       │
│   (280px 固定宽度)      │              (flex-1 自适应)                         │
│                        │                                                     │
│   ┌──────────────────┐ │  ┌───────────────────────────────────────────────┐  │
│   │ PRD 收集进度     │ │  │                                               │  │
│   │ ○───○───●───○    │ │  │   对话消息区域 (滚动)                          │  │
│   │ 2/4 完成         │ │  │                                               │  │
│   └──────────────────┘ │  │   - AI 竞品分析报告                            │  │
│                        │  │   - AI 方向选择引导                            │  │
│   ┌──────────────────┐ │  │   - 用户回复                                   │  │
│   │ 已收集信息       │ │  │   - AI 追问/总结                               │  │
│   │                  │ │  │                                               │  │
│   │ 📍 使用场景:     │ │  │   ┌──────────────────────────────────────┐    │  │
│   │    家用/办公     │ │  │   │ PRD 完成提示卡片                     │    │  │
│   │                  │ │  │   │ "PRD 收集完成，点击查看文档"         │    │  │
│   │ 👥 目标用户:     │ │  │   └──────────────────────────────────────┘    │  │
│   │    都市白领      │ │  │                                               │  │
│   │                  │ │  └───────────────────────────────────────────────┘  │
│   │ 🎨 外观风格:     │ │                                                     │
│   │    (待收集)      │ │  ┌───────────────────────────────────────────────┐  │
│   │                  │ │  │ 输入框                               [发送]  │  │
│   │ ⚡ 核心功能:     │ │  └───────────────────────────────────────────────┘  │
│   │    (待收集)      │ │                                                     │
│   └──────────────────┘ │                                                     │
│                        │                                                     │
│   ┌──────────────────┐ │                                                     │
│   │ 竞品图片参考     │ │                                                     │
│   │ [图][图][图]     │ │                                                     │
│   └──────────────────┘ │                                                     │
│                        │                                                     │
└────────────────────────┴─────────────────────────────────────────────────────┘
```

**左侧栏功能（PRD Writer AI 角色）**：
- 实时监听对话内容
- 自动提取结构化信息
- 显示收集进度
- 展示竞品图片参考

**右侧对话区功能（PM AI 角色）**：
- 以产品经理身份与用户对话
- 基于竞品数据给出专业分析
- 提供方向选择（A/B/C选项）
- 检测信息完整度，自动触发完成提示

### 第四部分：AI 角色分工

**AI产品经理（对话区）**：
- 角色：资深产品经理顾问
- 职责：分析竞品、引导方向选择、形成产品定义
- 交互：自然语言对话，提供选择题

**PRD Writer（侧边栏自动提取）**：
- 角色：文档撰写助手
- 职责：从对话中提取结构化信息
- 交互：无直接交互，后台自动运行

```text
对话流程:

用户进入板块2
       │
       ▼
AI产品经理输出竞品分析报告
  + 提出第一个方向选择
       │
       ▼
用户选择/回复
       │
       ▼
┌─────────────────────────────────┐
│ AI产品经理持续引导             │◄─────┐
│ PRD Writer 后台提取数据         │      │
│ 侧栏实时更新收集状态           │      │
└─────────────────────────────────┘      │
       │                                 │
       │  (信息不足)                     │
       └────────────────────────────────►┘
       │
       │  (信息足够: 4/4 收集完成)
       ▼
显示 "PRD 收集完成" 提示卡片
       │
       ▼
自动/手动进入板块3（PRD文档审核）
```

### 第五部分：Firecrawl 直接调用

**修改文件**：`supabase/functions/scrape-competitor/index.ts`

当前实现已使用 Firecrawl API 直接调用，无需通过 Lovable 代理。确认不做修改，保持现有逻辑：

```typescript
// 现有代码已正确实现
const response = await fetch("https://api.firecrawl.dev/v1/scrape", {
  method: "POST",
  headers: {
    "Authorization": `Bearer ${apiKey}`,
    "Content-Type": "application/json",
  },
  body: JSON.stringify({ url, formats: ["markdown", "screenshot"], ... }),
});
```

### 第六部分：阶段完成检测与自动推进

**板块1 → 板块2**：
- 触发条件：用户点击"完成研究"或"跳过"
- 已有逻辑，无需修改

**板块2 → 板块3**（新增逻辑）：
- 触发条件：PRD 4 个核心维度全部收集完成
- 实现方式：监听 `prdData` 变化，检测完成状态
- 提示方式：显示完成卡片 + 5秒倒计时自动跳转

**板块3 确认**：
- 触发条件：用户点击"确认 PRD 并进入视觉生成"
- 推进到 Stage 2（视觉生成阶段）

---

## 文件变更清单

| 文件路径 | 操作 | 描述 |
|---------|------|------|
| `src/components/PrdPhase.tsx` | 新建 | PRD 三阶段容器组件（类似 VisualGenerationPhase） |
| `src/components/PrdPhaseIndicator.tsx` | 新建 | 三阶段指示器组件 |
| `src/components/AiProductManagerPanel.tsx` | 新建 | AI产品经理对话面板（双栏布局） |
| `src/components/PrdExtractionSidebar.tsx` | 新建 | PRD 信息提取侧边栏 |
| `src/components/PrdDocumentPanel.tsx` | 新建 | 基于 PrdReviewPanel 改造的文档审核面板 |
| `src/pages/Project.tsx` | 修改 | 集成 PrdPhase 组件替换现有 PRD 逻辑 |
| `supabase/functions/chat/index.ts` | 修改 | 优化 AI 产品经理角色提示词 |

---

## 阶段过渡动画设计

**参照 VisualGenerationPhase 的过渡动画**：

```text
板块1 → 板块2 过渡:
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│   🎉 竞品分析完成！                                          │
│                                                             │
│   已分析 3 款竞品，128 条评论                                │
│   AI 产品经理将基于这些数据与您对话                          │
│                                                             │
│   [返回修改]          [开始对话 →]                           │
│                                                             │
└─────────────────────────────────────────────────────────────┘

板块2 → 板块3 过渡:
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│   ✅ PRD 信息收集完成！                                      │
│                                                             │
│   已收集：使用场景、目标用户、外观风格、核心功能              │
│   您可以在文档页面查看详情并进行修改                         │
│                                                             │
│   [继续对话]          [查看 PRD 文档 →]                      │
│                                                             │
│   5秒后自动进入...                                           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 数据流设计

```text
竞品数据流:
CompetitorResearch
       │
       │ onComplete(products, reviews)
       ▼
PrdPhase (存储到 state)
       │
       │ 传递给 AiProductManagerPanel
       ▼
AiProductManagerPanel
   ├─ 竞品图片 → PrdExtractionSidebar
   └─ 竞品数据 → AI 对话 system prompt

PRD 数据流:
AI 对话 (chat edge function)
       │
       │ 从回复中提取 prd-data 块
       ▼
后端保存到 projects.prd_data
       │
       │ 前端轮询/实时监听
       ▼
PrdExtractionSidebar 实时显示
       │
       │ 4/4 完成
       ▼
触发 PRD 完成提示
       │
       ▼
PrdDocumentPanel 展示完整文档
```

---

## 预期效果

1. **清晰的三阶段流程** - 用户一目了然当前进度
2. **专业的 AI 产品经理体验** - 基于真实竞品数据的专业分析
3. **实时 PRD 提取** - 对话过程中自动填充文档
4. **流畅的阶段过渡** - 动画效果增强体验
5. **灵活的审核编辑** - 最终文档可手动调整

